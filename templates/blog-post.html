{% extends "base.html" %}

{% block title %}{{ blog.title }} - ChowdhuryX Blog{% endblock %}

{% block content %}
<section class="blog-post-header">
    <div class="container">
        <article class="blog-post">
            <header class="post-header">
                <span class="category">{{ blog.category }}</span>
                <h1>{{ blog.title }}</h1>
                <div class="post-meta">
                    <span class="author"><i class="fas fa-user"></i> {{ blog.author }}</span>
                    <span class="date"><i class="fas fa-calendar"></i> {{ blog.published_at | datetime_format }}</span>
                    <span class="views"><i class="fas fa-eye"></i> {{ blog.views }} views</span>
                </div>
            </header>

            {% if blog.featured_image %}
            <img src="{{ url_for('static', filename='uploads/' + blog.featured_image) }}" alt="{{ blog.title }}" class="featured-image">
            {% else %}
            <img src="https://via.placeholder.com/900x400" alt="{{ blog.title }}" class="featured-image">
            {% endif %}

            <div class="post-body">
                {{ blog.content }}
            </div>

            <footer class="post-footer">
                <div class="post-tags">
                    <span class="tag">{{ blog.category }}</span>
                </div>
                <div class="post-actions">
                    <button onclick="likePost({{ blog.id }}, this)" class="action-btn" id="like-btn-{{ blog.id }}">
                        <i class="fas fa-heart"></i> <span id="like-count-{{ blog.id }}">0</span> Likes
                    </button>
                    <button onclick="sharePost('{{ blog.slug }}')" class="action-btn">
                        <i class="fas fa-share-alt"></i> Share
                    </button>
                </div>
            </footer>

            <!-- Comments Section -->
            <section class="comments-section">
                <h3>Discussion (<span id="comment-count">{{ blog.comments.filter_by(status='approved').count() }}</span>)</h3>
                
                <!-- Add Comment Form (No Login Required) -->
                <div class="add-comment-box">
                    <h4>Leave a Comment</h4>
                    <form method="POST" action="{{ url_for('add_blog_comment', blog_id=blog.id) }}" id="comment-form" class="comment-form">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        
                        <div class="form-row">
                            <input type="text" name="author_name" placeholder="Your Name *" required maxlength="120" class="form-control">
                            <input type="email" name="author_email" placeholder="Your Email *" required maxlength="120" class="form-control">
                        </div>
                        
                        <textarea name="content" placeholder="Share your thoughts... (No login required)" required maxlength="1000" rows="4" class="form-control"></textarea>
                        
                        <button type="submit" class="submit-btn">
                            <i class="fas fa-paper-plane"></i> Post Comment
                        </button>
                    </form>
                </div>

                <!-- Comments List -->
                <div class="comments-list" id="comments-list">
                    {% if blog.comments %}
                        {% for comment in blog.comments if comment.status == 'approved' %}
                        <div class="comment-item" id="comment-{{ comment.id }}">
                            <div class="comment-header">
                                <strong class="comment-author">{{ comment.author_name }}</strong>
                                <span class="comment-date">{{ comment.created_at.strftime('%B %d, %Y at %I:%M %p') }}</span>
                            </div>
                            <p class="comment-content">{{ comment.content }}</p>
                            <button onclick="likeComment({{ comment.id }}, this)" class="like-comment-btn">
                                <i class="fas fa-heart"></i> <span id="comment-like-{{ comment.id }}">0</span>
                            </button>
                        </div>
                        {% endfor %}
                        
                        {% if blog.comments|selectattr('status', 'equalto', 'approved')|list|length == 0 %}
                        <p class="no-comments">No comments yet. Be the first to share your thoughts!</p>
                        {% endif %}
                    {% else %}
                    <p class="no-comments">No comments yet. Be the first to share your thoughts!</p>
                    {% endif %}
                </div>
            </section>
        </article>

        <!-- Related Posts -->
        {% if related_blogs %}
        <section class="related-posts">
            <h3>Related Articles</h3>
            <div class="related-grid">
                {% for related in related_blogs %}
                <article class="related-card">
                    {% if related.featured_image %}
                    <img src="{{ url_for('static', filename='uploads/' + related.featured_image) }}" alt="{{ related.title }}">
                    {% else %}
                    <img src="https://via.placeholder.com/300x200" alt="{{ related.title }}">
                    {% endif %}
                    <h4><a href="{{ url_for('blog_post', slug=related.slug) }}">{{ related.title }}</a></h4>
                    <p>{{ related.excerpt or related.content[:100] }}...</p>
                    <a href="{{ url_for('blog_post', slug=related.slug) }}" class="read-more">Read More â†’</a>
                </article>
                {% endfor %}
            </div>
        </section>
        {% endif %}
    </div>
</section>

<style>
.post-actions {
    display: flex;
    gap: 1rem;
    margin-top: 1.5rem;
    padding-top: 1.5rem;
    border-top: 1px solid #e0e0e0;
}

.action-btn {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 1rem;
    background: #f5f5f5;
    border: 1px solid #ddd;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.3s ease;
    font-size: 0.9rem;
}

.action-btn:hover {
    background: #e0e0e0;
    border-color: #0066cc;
    color: #0066cc;
}

.comments-section {
    margin-top: 3rem;
    padding-top: 2rem;
    border-top: 2px solid #e0e0e0;
}

.comments-section h3 {
    margin-bottom: 2rem;
    font-size: 1.5rem;
}

.add-comment-box {
    background: #f9f9f9;
    padding: 1.5rem;
    border-radius: 8px;
    margin-bottom: 2rem;
    border: 1px solid #e0e0e0;
}

.add-comment-box h4 {
    margin: 0 0 1rem 0;
    font-size: 1.1rem;
}

.comment-form {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
}

@media (max-width: 768px) {
    .form-row {
        grid-template-columns: 1fr;
    }
}

.form-control {
    padding: 0.75rem;
    border: 1px solid #ddd;
    border-radius: 6px;
    font-family: inherit;
    font-size: 1rem;
    transition: all 0.3s ease;
}

.form-control:focus {
    outline: none;
    border-color: #0066cc;
    box-shadow: 0 0 0 3px rgba(0, 102, 204, 0.1);
}

textarea.form-control {
    resize: vertical;
    min-height: 100px;
}

.submit-btn {
    background: #0066cc;
    color: white;
    padding: 0.75rem 1.5rem;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 600;
    font-size: 1rem;
    transition: all 0.3s ease;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    width: fit-content;
}

.submit-btn:hover {
    background: #0052a3;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 102, 204, 0.3);
}

.comments-list {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
}

.comment-item {
    background: white;
    padding: 1.5rem;
    border-radius: 8px;
    border-left: 4px solid #0066cc;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
}

.comment-header {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 0.75rem;
    flex-wrap: wrap;
}

.comment-author {
    color: #333;
    font-size: 1rem;
}

.comment-date {
    color: #999;
    font-size: 0.85rem;
}

.comment-content {
    color: #555;
    line-height: 1.6;
    margin-bottom: 0.75rem;
    word-break: break-word;
}

.like-comment-btn {
    display: inline-flex;
    align-items: center;
    gap: 0.4rem;
    padding: 0.4rem 0.75rem;
    background: #f5f5f5;
    border: 1px solid #ddd;
    border-radius: 6px;
    cursor: pointer;
    font-size: 0.85rem;
    transition: all 0.3s ease;
}

.like-comment-btn:hover {
    color: #e74c3c;
    border-color: #e74c3c;
    background: #fee;
}

.no-comments {
    text-align: center;
    color: #999;
    padding: 2rem;
    font-style: italic;
}
</style>

<script>
function likePost(blogId, btn) {
    const icon = btn.querySelector('i');
    if (icon.classList.contains('fas')) {
        icon.classList.remove('fas');
        icon.classList.add('far');
    } else {
        icon.classList.remove('far');
        icon.classList.add('fas');
    }
    const count = btn.querySelector('span');
    count.textContent = parseInt(count.textContent) + (icon.classList.contains('fas') ? 1 : -1);
}

function likeComment(commentId, btn) {
    const icon = btn.querySelector('i');
    if (icon.classList.contains('fas')) {
        icon.classList.remove('fas');
        icon.classList.add('far');
    } else {
        icon.classList.remove('far');
        icon.classList.add('fas');
    }
    const count = btn.querySelector('span');
    count.textContent = parseInt(count.textContent) + (icon.classList.contains('fas') ? 1 : -1);
}

function sharePost(slug) {
    const url = window.location.href;
    if (navigator.share) {
        navigator.share({
            title: document.title,
            url: url
        });
    } else {
        const text = `Check out this article: ${document.title}\n${url}`;
        if (navigator.clipboard) {
            navigator.clipboard.writeText(text);
            alert('Link copied to clipboard!');
        }
    }
}

document.getElementById('comment-form').addEventListener('submit', function(e) {
    e.preventDefault();
    const form = this;
    const formData = new FormData(form);
    
    fetch(form.action, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Comment submitted! It will appear after admin approval.');
            form.reset();
        } else {
            alert('Error: ' + (data.message || 'Failed to post comment'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error submitting comment');
    });
});
</script>
{% endblock %}
