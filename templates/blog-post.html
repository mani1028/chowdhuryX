c{% extends "base.html" %}

{% block title %}{{ blog.title }} - ChowdhuryX Blog{% endblock %}

{% block css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/blog-post.css') }}">
{% endblock %}

{% block content %}
<section class="blog-post-header">
    <div class="container">
        <article class="blog-post">
            <header class="post-header">
                <span class="category">{{ blog.category }}</span>
                <h1>{{ blog.title }}</h1>
                <div class="post-meta">
                    <span class="author"><i class="fas fa-user"></i> {{ blog.author }}</span>
                    <span class="date"><i class="fas fa-calendar"></i> {{ blog.published_at | datetime_format }}</span>
                    <span class="views"><i class="fas fa-eye"></i> {{ blog.views }} views</span>
                </div>
            </header>

            <div class="featured-image-wrap">
                {% if blog.featured_image %}
                <img src="{{ url_for('static', filename='uploads/' + blog.featured_image) }}" alt="{{ blog.title }}" class="featured-image">
                {% else %}
                <img src="https://via.placeholder.com/1200x600" alt="{{ blog.title }}" class="featured-image">
                {% endif %}
            </div>

            <div class="post-body">
                {{ blog.content | safe }}
            </div>

            <footer class="post-footer">
                <div class="post-tags">
                    <span class="tag">{{ blog.category }}</span>
                </div>
                <div class="post-actions">
                    <button onclick="likePost({{ blog.id }}, this)" class="action-btn" id="like-btn-{{ blog.id }}">
                        <i class="far fa-heart"></i> <span id="like-count-{{ blog.id }}">{{ blog.likes or 0 }}</span> Likes
                    </button>
                    <button onclick="sharePost('{{ blog.slug }}')" class="action-btn">
                        <i class="fas fa-share-alt"></i> Share
                    </button>
                </div>
            </footer>

            <!-- Comments Section -->
            <section class="comments-section">
                <h3>Discussion (<span id="comment-count">{{ blog.comments|selectattr('status', 'equalto', 'approved')|list|length }}</span>)</h3>
                
                <!-- Add Comment Form (No Login Required) -->
                <div class="add-comment-box">
                    <h4>Leave a Comment</h4>
                    <form method="POST" action="{{ url_for('add_blog_comment', blog_id=blog.id) }}" id="comment-form" class="comment-form">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        
                        <div class="form-row">
                            <input type="text" name="author_name" placeholder="Your Name *" required maxlength="120" class="form-control">
                            <input type="email" name="author_email" placeholder="Your Email *" required maxlength="120" class="form-control">
                        </div>
                        
                        <textarea name="content" placeholder="Share your thoughts... (No login required)" required maxlength="1000" rows="4" class="form-control"></textarea>
                        
                        <button type="submit" class="submit-btn">
                            <i class="fas fa-paper-plane"></i> Post Comment
                        </button>
                    </form>
                </div>

                <!-- Comments List -->
                <div class="comments-list" id="comments-list">
                    {% set visible_comments = blog.comments|selectattr('status', 'equalto', 'approved')|list %}
                    {% if visible_comments %}
                        {% for comment in visible_comments %}
                        <div class="comment-item" id="comment-{{ comment.id }}">
                            <div class="comment-header">
                                <strong class="comment-author">{{ comment.author_name }}</strong>
                                <span class="comment-date">{{ comment.created_at.strftime('%B %d, %Y at %I:%M %p') }}</span>
                            </div>
                            <p class="comment-content">{{ comment.content }}</p>
                            <button onclick="likeComment({{ comment.id }}, this)" class="like-comment-btn">
                                <i class="far fa-heart"></i> <span id="comment-like-{{ comment.id }}">{{ comment.likes or 0 }}</span>
                            </button>
                        </div>
                        {% endfor %}
                    {% else %}
                    <p class="no-comments">No comments yet. Be the first to share your thoughts!</p>
                    {% endif %}
                </div>
            </section>
        </article>

        <!-- Related Posts -->
        {% if related_blogs %}
        <section class="related-posts">
            <h3>Related Articles</h3>
            <div class="related-grid">
                {% for related in related_blogs %}
                <article class="related-card">
                    {% if related.featured_image %}
                    <img src="{{ url_for('static', filename='uploads/' + related.featured_image) }}" alt="{{ related.title }}">
                    {% else %}
                    <img src="https://via.placeholder.com/300x200" alt="{{ related.title }}">
                    {% endif %}
                    <h4><a href="{{ url_for('blog_post', slug=related.slug) }}">{{ related.title }}</a></h4>
                    <p>{{ related.excerpt or related.content[:100] }}...</p>
                    <a href="{{ url_for('blog_post', slug=related.slug) }}" class="read-more">Read More â†’</a>
                </article>
                {% endfor %}
            </div>
        </section>
        {% endif %}
    </div>
</section>

<script>
// Initialize likes on page load
document.addEventListener('DOMContentLoaded', function() {
    // Load blog post like state
    const blogId = {{ blog.id }};
    const blogLiked = localStorage.getItem('blog_like_' + blogId);
    if (blogLiked === 'true') {
        const btn = document.getElementById('like-btn-' + blogId);
        if (btn) {
            const icon = btn.querySelector('i');
            icon.classList.remove('far');
            icon.classList.add('fas');
        }
    }
    
    // Load comment like states
    document.querySelectorAll('[id^="comment-like-"]').forEach(span => {
        const commentId = span.id.replace('comment-like-', '');
        const commentLiked = localStorage.getItem('comment_like_' + commentId);
        if (commentLiked === 'true') {
            const btn = span.closest('button');
            if (btn) {
                const icon = btn.querySelector('i');
                icon.classList.remove('far');
                icon.classList.add('fas');
            }
        }
    });
});

function likePost(blogId, btn) {
    const icon = btn.querySelector('i');
    const isLiked = icon.classList.contains('fas');
    const count = btn.querySelector('span');
    const currentCount = parseInt(count.textContent) || 0;
    
    // Check if already liked on this device
    const liked = localStorage.getItem('blog_like_' + blogId);
    
    if (liked === 'true') {
        // Already liked, prevent multiple likes
        return;
    }
    
    // Update UI immediately
    icon.classList.remove('far');
    icon.classList.add('fas');
    count.textContent = currentCount + 1;
    
    // Save to localStorage
    localStorage.setItem('blog_like_' + blogId, 'true');
    
    // Send to backend
    fetch('/blog/' + blogId + '/like', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ action: 'like' })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            count.textContent = data.likes;
        }
    })
    .catch(error => {
        console.error('Error:', error);
    });
}

function likeComment(commentId, btn) {
    const icon = btn.querySelector('i');
    const isLiked = icon.classList.contains('fas');
    const count = btn.querySelector('span');
    const currentCount = parseInt(count.textContent) || 0;
    
    // Check if already liked on this device
    const liked = localStorage.getItem('comment_like_' + commentId);
    
    if (liked === 'true') {
        // Already liked, prevent multiple likes
        return;
    }
    
    // Update UI immediately
    icon.classList.remove('far');
    icon.classList.add('fas');
    count.textContent = currentCount + 1;
    
    // Save to localStorage
    localStorage.setItem('comment_like_' + commentId, 'true');
    
    // Send to backend
    fetch('/comment/' + commentId + '/like', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ action: 'like' })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            count.textContent = data.likes;
        }
    })
    .catch(error => {
        console.error('Error:', error);
    });
}

function sharePost(slug) {
    const url = window.location.href;
    if (navigator.share) {
        navigator.share({
            title: document.title,
            url: url
        });
    } else {
        const text = `Check out this article: ${document.title}\n${url}`;
        if (navigator.clipboard) {
            navigator.clipboard.writeText(text);
            alert('Link copied to clipboard!');
        }
    }
}

document.getElementById('comment-form').addEventListener('submit', function(e) {
    e.preventDefault();
    const form = this;
    const formData = new FormData(form);
    
    fetch(form.action, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Comment posted successfully!');
            location.reload(); // Reload to show the new comment
        } else {
            alert('Error: ' + (data.message || 'Failed to post comment'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error submitting comment');
    });
});
</script>
{% endblock %}
